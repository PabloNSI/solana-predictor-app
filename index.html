<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Predictor - Gráficos Dinámicos por Período</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* Estilos idénticos a tu versión anterior - sin emoticonos */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
        
        header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 24px 0;
            border-bottom: 1px solid #334155;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00ffa3, #03e1ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 12px;
        }
        
        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #475569;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #475569;
        }
        
        .chat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00ffa3, #03e1ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #0f172a;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }
        
        .user-message {
            text-align: right;
        }
        
        .bot-message {
            text-align: left;
        }
        
        .message-bubble {
            display: inline-block;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message .message-bubble {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message .message-bubble {
            background: rgba(71, 85, 105, 0.7);
            border-bottom-left-radius: 4px;
            color: #e2e8f0;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 4px;
            margin-left: 10px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }
        
        #userInput {
            flex: 1;
            padding: 14px 18px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #475569;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border 0.3s;
        }
        
        #userInput:focus {
            border-color: #00ffa3;
        }
        
        #sendButton {
            padding: 14px 24px;
            background: linear-gradient(90deg, #00ffa3, #03e1ff);
            color: #0f172a;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #sendButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 163, 0.3);
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 24px;
        }
        
        .analysis-card {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            border-left: 4px solid #00ffa3;
        }
        
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .indicator {
            text-align: center;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
        }
        
        .indicator-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .positive { color: #00ffa3; }
        .neutral { color: #03e1ff; }
        .warning { color: #fbbf24; }
        
        .query-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .query-example {
            padding: 8px 16px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .query-example:hover {
            background: rgba(71, 85, 105, 0.8);
        }
        
        footer {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #334155;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .disclaimer {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            color: #fca5a5;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #94a3b8;
        }
        
        .loading::after {
            content: "";
            width: 20px;
            height: 20px;
            border: 2px solid #00ffa3;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Solana Predictor</h1>
            <p class="subtitle">Gráficos dinámicos por período con datos reales de Solana (2020-2025)</p>
            <div class="disclaimer">
                SIMULACIÓN ACADÉMICA: Esta aplicación utiliza datos históricos reales hasta 2025. Las predicciones a partir de 2025 son simulaciones basadas en datos históricos.
            </div>
        </header>
        
        <div class="card">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-icon">AI</div>
                    <div>
                        <h2>Asistente de Análisis</h2>
                        <p style="color: #94a3b8; font-size: 0.9rem;">Pide gráficos por período: 2025, anual, este año, etc.</p>
                    </div>
                </div>
                
                <div class="chat-history" id="chatHistory">
                    <div class="message bot-message">
                        <div class="message-bubble">
                            <div class="loading">Cargando datos históricos de Solana...</div>
                        </div>
                        <div class="message-time">Ahora</div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" id="userInput" placeholder="Esperando datos..." autocomplete="off" disabled>
                    <button id="sendButton" disabled>Enviar</button>
                </div>
                
                <div class="query-examples" id="queryExamples" style="display: none;">
                    <div class="query-example" onclick="insertExample('gráfico de 2025')">Gráfico 2025</div>
                    <div class="query-example" onclick="insertExample('gráfico anual')">Gráfico anual</div>
                    <div class="query-example" onclick="insertExample('gráfico de este año')">Este año</div>
                    <div class="query-example" onclick="insertExample('gráfico de los últimos 30 días')">Últimos 30 días</div>
                    <div class="query-example" onclick="insertExample('gráfico de los últimos 7 días')">Últimos 7 días</div>
                    <div class="query-example" onclick="insertExample('predice el precio para mañana')">Predice mañana</div>
                    <div class="query-example" onclick="insertExample('tendencia para la próxima semana')">Tendencia semana</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="chat-header">
                <div class="chat-icon">VC</div>
                <div>
                    <h2>Visualizaciones Dinámicas</h2>
                    <p style="color: #94a3b8; font-size: 0.9rem;">El gráfico se actualiza según el período solicitado</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            
            <div id="analysisResults">
                <div class="analysis-card">
                    <h3>Información Actual de SOL</h3>
                    <p>Cargando datos históricos desde el archivo CSV...</p>
                </div>
                
                <div class="indicator-grid" id="indicators">
                    <!-- Los indicadores se generarán aquí -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>Proyecto Final Unit 25: Applied Machine Learning • Pearson HND • SIMULACIÓN ACADÉMICA</p>
            <p style="margin-top: 8px; font-size: 0.8rem;">Datos reales: 2020-2025 • Gráficos dinámicos por período</p>
        </footer>
    </div>

    <script>
    // ============================================
    // CONFIGURACIÓN PRINCIPAL Y VARIABLES GLOBALES
    // ============================================
    const ctx = document.getElementById('priceChart').getContext('2d');
    let priceChart = null; // Inicializar como null
    let historicalData = [];
    let processedData = [];
    let lastRealDate = null;
    let lastRealPrice = 0;
    let currentSimulatedDate = null;
    let currentSimulatedPrice = 0;
    let lastQueryType = '';
    let chartInitialized = false; // Bandera para controlar inicialización
    
    // Fecha de simulación: 1 de enero de 2025
    const SIMULATION_DATE = new Date('2025-01-01');
    
    // ============================================
    // FUNCIÓN PARA DESTRUIR GRÁFICO ANTERIOR
    // ============================================
    function destroyExistingChart() {
        if (priceChart !== null) {
            try {
                priceChart.destroy();
            } catch (e) {
                console.log('Error al destruir gráfico anterior:', e);
            }
            priceChart = null;
        }
    }
    
    // ============================================
    // FUNCIONES DE CARGA Y PROCESAMIENTO DE DATOS
    // ============================================
    
    async function loadCSVData() {
        try {
            console.log('Intentando cargar CSV...');
            
            // Intenta diferentes rutas posibles
            let csvPath = 'sol_1d_data_2020_to_2025.csv';
            let response = await fetch(csvPath);
            
            // Si falla, intenta con ruta absoluta
            if (!response.ok) {
                csvPath = './sol_1d_data_2020_to_2025.csv';
                response = await fetch(csvPath);
            }
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const csvText = await response.text();
            console.log('CSV cargado, tamaño:', csvText.length, 'bytes');
            
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log('CSV parseado. Registros:', results.data.length);
                        
                        if (results.errors && results.errors.length > 0) {
                            console.warn('Errores en el parseo:', results.errors);
                        }
                        
                        if (results.data.length === 0) {
                            console.warn('CSV vacío o sin datos válidos');
                            createFallbackData();
                        } else {
                            historicalData = results.data;
                        }
                        
                        processHistoricalData();
                        resolve();
                    },
                    error: function(error) {
                        console.error('Error parseando CSV:', error);
                        reject(error);
                    }
                });
            });
        } catch (error) {
            console.error('Error cargando CSV:', error);
            // Fallback a datos de ejemplo
            createFallbackData();
            processHistoricalData();
            return Promise.resolve();
        }
    }
    
    function processHistoricalData() {
        console.log('Procesando datos históricos...');
        
        // Filtrar y procesar los datos
        processedData = historicalData
            .filter(row => row['Open time'] && row['Close'] && !isNaN(row['Close']))
            .map(row => {
                const date = new Date(row['Open time']);
                return {
                    date: date,
                    open: row['Open'] || 0,
                    high: row['High'] || 0,
                    low: row['Low'] || 0,
                    close: row['Close'] || 0,
                    volume: row['Volume'] || 0,
                    trades: row['Number of trades'] || 0,
                    isReal: true
                };
            })
            .sort((a, b) => a.date - b.date);
            
        console.log(`Datos procesados: ${processedData.length} registros`);
        
        // Encontrar el último dato real (antes de la fecha de simulación)
        const realData = processedData.filter(d => d.date <= SIMULATION_DATE);
        
        if (realData.length > 0) {
            const lastReal = realData[realData.length - 1];
            lastRealDate = lastReal.date;
            lastRealPrice = lastReal.close;
            currentSimulatedDate = new Date(SIMULATION_DATE);
            currentSimulatedPrice = lastRealPrice;
            
            console.log(`Último dato real: ${lastRealDate.toLocaleDateString()} - $${lastRealPrice}`);
            console.log(`Fecha de simulación: ${currentSimulatedDate.toLocaleDateString()}`);
        } else {
            // Si no hay datos reales, usar valores por defecto
            console.warn('No se encontraron datos reales antes de la fecha de simulación');
            lastRealDate = new Date('2024-12-31');
            lastRealPrice = 150.0;
            currentSimulatedDate = new Date(SIMULATION_DATE);
            currentSimulatedPrice = lastRealPrice;
        }
    }
    
    function createFallbackData() {
        console.log('Creando datos de ejemplo (fallback)...');
        
        const startDate = new Date('2020-08-11');
        const basePrice = 2.85;
        historicalData = [];
        
        // Crear 4 años de datos (2020-2024)
        for (let i = 0; i < 1460; i++) { // 4 años * 365 días
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            // Generar precio con tendencia alcista
            const yearsFromStart = i / 365;
            const baseTrend = Math.pow(1.5, yearsFromStart);
            const seasonal = Math.sin(yearsFromStart * 2 * Math.PI) * 0.2;
            const noise = (Math.random() - 0.5) * 0.3;
            const price = basePrice * baseTrend * (1 + seasonal + noise);
            
            historicalData.push({
                'Open time': date.toISOString(),
                'Close': price,
                'Open': price * (1 - Math.random() * 0.02),
                'High': price * (1 + Math.random() * 0.03),
                'Low': price * (1 - Math.random() * 0.03),
                'Volume': 1000000 + Math.random() * 2000000,
                'Number of trades': 10000 + Math.random() * 20000
            });
        }
        
        console.log('Datos de ejemplo creados:', historicalData.length, 'registros');
    }
    
    // ============================================
    // FUNCIONES DE ACTUALIZACIÓN DE GRÁFICOS
    // ============================================
    
    function initializeChart() {
        console.log('Inicializando gráfico...');
        
        // Destruir gráfico existente
        destroyExistingChart();
        
        // Crear gráfico inicial (últimos 30 días)
        createChartForPeriod('Últimos 30 días');
        
        updateIndicators(generateInitialIndicators());
        updateAnalysisText('inicialización');
        
        chartInitialized = true;
        console.log('Gráfico inicializado correctamente');
    }
    
    function createChartForPeriod(title) {
        // Destruir gráfico anterior
        destroyExistingChart();
        
        // Obtener datos para los últimos 30 días
        const endDate = new Date(currentSimulatedDate);
        const startDate = new Date(currentSimulatedDate);
        startDate.setDate(startDate.getDate() - 30);
        
        const periodData = getDataForPeriod(startDate, endDate);
        
        // Si no hay datos, crear datos de ejemplo
        const displayData = periodData.length > 0 ? periodData : generateSampleData(30);
        
        const labels = displayData.map(d => 
            d.date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })
        );
        
        const prices = displayData.map(d => d.close);
        
        // Crear nuevo gráfico
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Precio de SOL (USD) - ${title}`,
                    data: prices,
                    borderColor: '#00ffa3',
                    backgroundColor: 'rgba(0, 255, 163, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        labels: { 
                            color: '#e2e8f0',
                            font: { size: 12 }
                        } 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `$${context.parsed.y.toFixed(4)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { 
                            color: '#94a3b8',
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { 
                            color: '#94a3b8',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function generateSampleData(days) {
        const sampleData = [];
        const basePrice = currentSimulatedPrice;
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(currentSimulatedDate);
            date.setDate(date.getDate() - i);
            
            const change = (Math.random() - 0.5) * 0.04; // +/- 2%
            const price = i === days - 1 ? basePrice * (1 + change) : 
                         sampleData[sampleData.length - 1].close * (1 + change);
            
            sampleData.push({
                date: date,
                close: Math.max(0.1, price),
                isReal: false
            });
        }
        
        return sampleData;
    }
    
    function updateChartForPeriod(query) {
        console.log('Actualizando gráfico para consulta:', query);
        
        const periodInfo = parsePeriodQuery(query);
        let title = '';
        
        // Determinar título y datos según el período
        if (periodInfo.type === 'year') {
            title = `Año ${periodInfo.year}`;
        } else if (periodInfo.type === 'last_days') {
            title = `Últimos ${periodInfo.days} días`;
        } else {
            title = 'Período solicitado';
        }
        
        // Destruir y crear nuevo gráfico
        destroyExistingChart();
        
        // Crear gráfico con datos apropiados
        if (periodInfo.type === 'year' && periodInfo.year === 2025) {
            createYearChart(2025);
        } else if (periodInfo.type === 'last_days') {
            createLastDaysChart(periodInfo.days);
        } else {
            createChartForPeriod(title);
        }
    }
    
    function createYearChart(year) {
        // Generar datos para el año completo
        const yearData = generateYearData(year);
        
        // Muestrear para no sobrecargar el gráfico
        const sampledData = sampleData(yearData, 50);
        
        const labels = sampledData.map(d => 
            d.date.toLocaleDateString('es-ES', { month: 'short' })
        );
        
        const prices = sampledData.map(d => d.close);
        
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Precio de SOL (USD) - Año ${year}`,
                    data: prices,
                    borderColor: '#00ffa3',
                    backgroundColor: 'rgba(0, 255, 163, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#e2e8f0' } }
                },
                scales: {
                    x: { 
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { 
                            color: '#94a3b8',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function createLastDaysChart(days) {
        const endDate = new Date(currentSimulatedDate);
        const startDate = new Date(currentSimulatedDate);
        startDate.setDate(startDate.getDate() - days);
        
        const periodData = getDataForPeriod(startDate, endDate);
        const displayData = periodData.length > 0 ? periodData : generateSampleData(days);
        
        const labels = displayData.map(d => 
            d.date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })
        );
        
        const prices = displayData.map(d => d.close);
        
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Precio de SOL (USD) - Últimos ${days} días`,
                    data: prices,
                    borderColor: '#00ffa3',
                    backgroundColor: 'rgba(0, 255, 163, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#e2e8f0' } }
                },
                scales: {
                    x: { 
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        grid: { color: 'rgba(71, 85, 105, 0.3)' },
                        ticks: { 
                            color: '#94a3b8',
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // ============================================
    // FUNCIONES AUXILIARES (MANTENER LAS EXISTENTES)
    // ============================================
    
    function parsePeriodQuery(query) {
        query = query.toLowerCase();
        
        // Detectar año específico
        const yearMatch = query.match(/(\d{4})/);
        if (yearMatch) {
            const year = parseInt(yearMatch[1]);
            return {
                type: 'year',
                year: year,
                startDate: new Date(year, 0, 1),
                endDate: new Date(year, 11, 31)
            };
        }
        
        // Detectar "últimos X días"
        const daysMatch = query.match(/últimos\s*(\d+)\s*d[ií]as/) || 
                         query.match(/(\d+)\s*d[ií]as/);
        if (daysMatch) {
            const days = parseInt(daysMatch[1]);
            const endDate = new Date(currentSimulatedDate);
            const startDate = new Date(currentSimulatedDate);
            startDate.setDate(startDate.getDate() - days);
            
            return {
                type: 'last_days',
                days: days,
                startDate: startDate,
                endDate: endDate
            };
        }
        
        // Por defecto: últimos 30 días
        const defaultStartDate = new Date(currentSimulatedDate);
        defaultStartDate.setDate(defaultStartDate.getDate() - 30);
        
        return {
            type: 'default',
            startDate: defaultStartDate,
            endDate: currentSimulatedDate
        };
    }
    
    function getDataForPeriod(startDate, endDate) {
        return processedData.filter(d => 
            d.date >= startDate && d.date <= endDate && d.isReal
        );
    }
    
    function generateYearData(year) {
        const yearData = [];
        const startDate = new Date(year, 0, 1);
        const endDate = new Date(year, 11, 31);
        let currentPrice = currentSimulatedPrice;
        
        // Generar datos para cada mes (simplificado)
        for (let month = 0; month < 12; month++) {
            const date = new Date(year, month, 15); // Día 15 de cada mes
            
            // Variación mensual
            const monthlyChange = (Math.random() - 0.5) * 0.1; // +/- 5%
            currentPrice = currentPrice * (1 + monthlyChange);
            
            yearData.push({
                date: date,
                close: Math.max(0.1, currentPrice),
                isReal: false
            });
        }
        
        return yearData;
    }
    
    function sampleData(data, maxPoints) {
        if (data.length <= maxPoints) return data;
        
        const sampled = [];
        const step = data.length / maxPoints;
        
        for (let i = 0; i < maxPoints; i++) {
            const index = Math.floor(i * step);
            sampled.push(data[index]);
        }
        
        return sampled;
    }
    
    function getCurrentTime() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') + ':' + 
               now.getMinutes().toString().padStart(2, '0');
    }
    
    function insertExample(text) {
        document.getElementById('userInput').value = text;
    }
    
    function addMessageToChat(sender, message) {
        const chatHistory = document.getElementById('chatHistory');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        const time = getCurrentTime();
        messageDiv.innerHTML = `
            <div class="message-bubble">${message}</div>
            <div class="message-time">${time}</div>
        `;
        
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function simulateTyping() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot-message';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-bubble pulse">Procesando...</div>
            <div class="message-time">${getCurrentTime()}</div>
        `;
        
        document.getElementById('chatHistory').appendChild(typingDiv);
        document.getElementById('chatHistory').scrollTop = chatHistory.scrollHeight;
        
        return typingDiv;
    }
    
    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    function updateIndicators(indicators) {
        const indicatorsContainer = document.getElementById('indicators');
        if (!indicatorsContainer) return;
        
        indicatorsContainer.innerHTML = '';
        
        indicators.forEach(indicator => {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'indicator';
            
            let statusClass = '';
            if (indicator.status === 'positive') statusClass = 'positive';
            else if (indicator.status === 'warning') statusClass = 'warning';
            else statusClass = 'neutral';
            
            indicatorDiv.innerHTML = `
                <div style="font-size: 0.9rem; color: #94a3b8;">${indicator.name}</div>
                <div class="indicator-value ${statusClass}">${indicator.value}</div>
                <div style="font-size: 0.85rem; color: ${indicator.status === 'positive' ? '#00ffa3' : indicator.status === 'warning' ? '#fbbf24' : '#03e1ff'}">
                    ${indicator.change}
                </div>
            `;
            
            indicatorsContainer.appendChild(indicatorDiv);
        });
    }
    
    // FUNCIÓN CORREGIDA - SIN ERRORES DE NULL
    function updateAnalysisText(query) {
        const analysisResults = document.getElementById('analysisResults');
        if (!analysisResults) return;
        
        const analysisCard = analysisResults.querySelector('.analysis-card') || document.createElement('div');
        
        const periodInfo = parsePeriodQuery(query);
        
        // USAR VALORES SEGUROS (no lanzar errores si son null)
        const lastRealDateString = lastRealDate ? 
            lastRealDate.toLocaleDateString('es-ES') : 
            'fecha no disponible';
        
        const startDateString = periodInfo.startDate ? 
            periodInfo.startDate.toLocaleDateString('es-ES') : 
            'fecha no disponible';
        
        const endDateString = periodInfo.endDate ? 
            periodInfo.endDate.toLocaleDateString('es-ES') : 
            'fecha no disponible';
        
        let analysisText = '';
        
        if (periodInfo.type === 'year' && periodInfo.year === 2025) {
            analysisText = `
                <h3>Gráfico Anual 2025</h3>
                <p>Este gráfico muestra datos de Solana para el año 2025. ${processedData.length > 0 ? 
                    `Tenemos ${processedData.length} registros históricos.` : 
                    'Usando datos simulados para demostración.'}</p>
                <p style="margin-top: 10px; color: #94a3b8; font-size: 0.9rem;">
                    Último dato disponible: ${lastRealDateString}
                </p>
            `;
        } else if (periodInfo.type === 'last_days') {
            analysisText = `
                <h3>Gráfico de los últimos ${periodInfo.days} días</h3>
                <p>Este gráfico muestra ${periodInfo.days} días de datos de Solana.</p>
                <p style="margin-top: 10px; color: #94a3b8; font-size: 0.9rem;">
                    Período: ${startDateString} - ${endDateString}
                </p>
            `;
        } else {
            analysisText = `
                <h3>Análisis de Datos de Solana</h3>
                <p>${processedData.length > 0 ? 
                    `Base de datos: ${processedData.length} registros históricos cargados.` : 
                    'Usando datos simulados para demostración.'}</p>
                <p style="margin-top: 10px; color: #94a3b8; font-size: 0.9rem;">
                    Simulación actual: año 2025 | Precio: $${currentSimulatedPrice.toFixed(2)}
                </p>
            `;
        }
        
        if (!analysisResults.querySelector('.analysis-card')) {
            analysisCard.className = 'analysis-card';
            analysisResults.insertBefore(analysisCard, document.getElementById('indicators'));
        }
        
        analysisCard.innerHTML = analysisText;
    }
    
    // ============================================
    // ANÁLISIS DE CONSULTAS (VERSIÓN SIMPLIFICADA)
    // ============================================
    
    function analyzeQuery(query) {
        query = query.toLowerCase();
        let response = '';
        let indicators = [];
        
        if (query.includes('gráfico') || query.includes('grafico') || 
            query.includes('muestra') || query.includes('ver')) {
            
            lastQueryType = 'chart';
            const periodInfo = parsePeriodQuery(query);
            
            if (periodInfo.type === 'year') {
                response = `He generado un gráfico del año ${periodInfo.year}.`;
            } else if (periodInfo.type === 'last_days') {
                response = `He generado un gráfico de los últimos ${periodInfo.days} días.`;
            } else {
                response = `He generado un gráfico con los datos solicitados.`;
            }
            
            indicators = generateInitialIndicators();
            updateChartForPeriod(query);
            
        } else if (query.includes('precio') && query.includes('mañana')) {
            
            lastQueryType = 'prediction';
            const predictedPrice = generatePrediction(1);
            const changePercent = ((predictedPrice - currentSimulatedPrice) / currentSimulatedPrice * 100).toFixed(2);
            
            response = `
                Mi predicción para mañana: <strong>$${predictedPrice.toFixed(2)}</strong><br>
                Cambio estimado: <strong>${changePercent}%</strong>
            `;
            
            indicators = generatePredictionIndicators();
            
        } else {
            lastQueryType = 'general';
            response = `
                Puedo mostrarte:<br>
                • <strong>Gráfico de 2025</strong> (año completo)<br>
                • <strong>Gráfico de los últimos X días</strong> (ej: 7, 30, 90 días)<br>
                • <strong>Predicciones</strong> para mañana
            `;
            indicators = generateInitialIndicators();
        }
        
        return { response, indicators };
    }
    
    function generatePrediction(daysAhead = 1) {
        // Predicción simple basada en el precio actual
        const volatility = 0.02; // 2% de volatilidad diaria
        const change = (Math.random() - 0.5) * 2 * volatility * daysAhead;
        return currentSimulatedPrice * (1 + change);
    }
    
    function generateInitialIndicators() {
        return [
            { name: 'Precio Actual', value: `$${currentSimulatedPrice.toFixed(2)}`, change: '+1.2%', status: 'positive' },
            { name: 'Volumen 24h', value: '$2.4B', change: '+5.7%', status: 'positive' },
            { name: 'Volatilidad', value: '28.5%', change: 'Alta', status: 'warning' },
            { name: 'RSI (14 días)', value: '62.5', change: 'Neutral', status: 'neutral' },
            { name: 'SMA (50 días)', value: `$${(currentSimulatedPrice * 0.98).toFixed(2)}`, change: 'Soporte', status: 'neutral' },
            { name: 'Sentimiento', value: 'Positivo', change: '72%', status: 'positive' }
        ];
    }
    
    function generatePredictionIndicators() {
        const tomorrowPrice = generatePrediction(1);
        const changePercent = ((tomorrowPrice - currentSimulatedPrice) / currentSimulatedPrice * 100).toFixed(2);
        
        return [
            { name: 'Precio Actual', value: `$${currentSimulatedPrice.toFixed(2)}`, change: '+1.2%', status: 'positive' },
            { name: 'Predicción 24h', value: `$${tomorrowPrice.toFixed(2)}`, change: `${changePercent}%`, status: parseFloat(changePercent) > 0 ? 'positive' : 'warning' },
            { name: 'Confianza', value: '78%', change: 'Alta', status: 'positive' },
            { name: 'Rango Esperado', value: `$${(tomorrowPrice * 0.97).toFixed(2)}-$${(tomorrowPrice * 1.03).toFixed(2)}`, change: '±3.2%', status: 'warning' },
            { name: 'Volatilidad Est.', value: '2.8%', change: 'Media', status: 'neutral' },
            { name: 'Recomendación', value: parseFloat(changePercent) > 1 ? 'Observar' : 'Neutral', change: 'Neutral', status: 'neutral' }
        ];
    }
    
    // ============================================
    // MANEJO DE INTERACCIÓN
    // ============================================
    
    function processUserInput() {
        const userInput = document.getElementById('userInput').value.trim();
        if (!userInput) return;
        
        addMessageToChat('user', userInput);
        document.getElementById('userInput').value = '';
        
        const typingIndicator = simulateTyping();
        
        setTimeout(() => {
            removeTypingIndicator();
            
            const analysis = analyzeQuery(userInput);
            addMessageToChat('bot', analysis.response);
            
            updateIndicators(analysis.indicators);
            updateAnalysisText(userInput);
        }, 1500);
    }
    
    // ============================================
    // INICIALIZACIÓN CORREGIDA
    // ============================================
    
    async function initializeApp() {
        console.log('Inicializando aplicación...');
        
        try {
            // Cargar datos primero
            await loadCSVData();
            
            console.log('Datos cargados, procesados:', processedData.length, 'registros');
            
            // Inicializar gráfico
            initializeChart();
            
            // Habilitar interfaz
            document.getElementById('userInput').placeholder = "Pide un gráfico (ej: gráfico de 2025, últimos 30 días)";
            document.getElementById('userInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            const queryExamples = document.getElementById('queryExamples');
            if (queryExamples) {
                queryExamples.style.display = 'flex';
            }
            
            // Limpiar mensaje de carga
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                chatHistory.innerHTML = '';
            }
            
            // Mensaje de bienvenida
            addMessageToChat('bot', `
                ¡Listo! ${processedData.length > 0 ? 
                    `He cargado <strong>${processedData.length} registros</strong> de datos de Solana.` : 
                    `Estoy usando datos simulados para la demostración.`}<br><br>
                <strong>Puedes pedir:</strong><br>
                • "gráfico de 2025"<br>
                • "gráfico de los últimos 7 días"<br>
                • "gráfico de los últimos 30 días"<br>
                • "predice el precio para mañana"<br><br>
                ¿Qué te gustaría ver?
            `);
            
            // Configurar event listeners
            document.getElementById('sendButton').addEventListener('click', processUserInput);
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') processUserInput();
            });
            
            console.log('Aplicación inicializada correctamente');
            
        } catch (error) {
            console.error('Error crítico en inicialización:', error);
            
            // Mensaje de error amigable
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                chatHistory.innerHTML = '';
                addMessageToChat('bot', 'Hubo un problema al cargar los datos. Usando versión de demostración con datos simulados.');
            }
            
            // Inicializar con datos de ejemplo
            if (!chartInitialized) {
                initializeChart();
            }
            
            // Habilitar interfaz de todos modos
            document.getElementById('userInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            const queryExamples = document.getElementById('queryExamples');
            if (queryExamples) {
                queryExamples.style.display = 'flex';
            }
        }
    }
    
    // Inicializar cuando la página cargue
    window.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>